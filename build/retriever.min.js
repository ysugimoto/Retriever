!function(a){function b(a){this.token=a,this.size=a.length,this.idx=0}function c(a){this.cond=this.tokenize(a),this.idx=0,this.compare="",this.leftValue=[],this.rightValue=[]}function d(a,b){this.condition=a,this.contexts=this.analyze(b)}function e(a){this.tpl=a.split(""),this.size=a.length,this.idx=0,this.mode=e.STATUS_NORMAL,this.processTree=[],this.parsed=[],this.line=1,this.nestLevel=0,this.leftDelimiter="{{",this.rightDelimiter="}}"}b.make=function(a){return new b(a)},b.prototype.calculate=function(){return this.idx=0,this.addSub()},b.prototype.addSub=function(){for(var a=this.mulDiv();this.idx<this.size&&/[\+\-]/.test(this.token[this.idx]);)"+"===this.token[this.idx++]?a+=this.mulDiv():a-=this.mulDiv();return a},b.prototype.mulDiv=function(){for(var a=this.factor();this.idx<this.size&&/[\*\/]/.test(this.token[this.idx]);)"*"===this.token[this.idx++]?a*=this.factor():a/=this.factor();return a},b.prototype.factor=function(){var a;if("("===this.token[this.idx]){if(this.idx++,a=this.addSub(),")"!==this.token[this.idx])throw new Error('Syntax Error: Invalid factor of "(".');this.idx++}else a=this.token[this.idx++],/^[0-9\.]+$/.test(a)&&(a=parseFloat(a));return a},c.make=function(a){return new c(a)},c.prototype.tokenize=function(a){return a=a.replace(/([><=!&\|\/\-\+\*]{,3}?)/g," $1 ").replace("  "," "),a.split(" ").map(function(a){return a.trim()})},c.prototype.getRecursiveValue=function(a,b){var c,d=a.indexOf(".");return-1===d?a in b?b[a]:null:(c=a.slice(0,d),c in b&&"object"==typeof b[c]?this.getRecursiveValue(a.slice(++d),b[c]):null)},c.prototype.acceptance=function(a,b){var c,d,e=b||0,f=this.cond[e++];if(void 0===f)return this._compare();if(/^[<>=]+$/.test(f)){if(""!==this.compare)throw new Error("Syntax Error: Bad operator "+f+" after "+this.compare);this.compare=f,c=this.cond[e++],d=this.parsePrimitiveValue(c),this.rightValue[this.rightValue.length]=null!==d?d:this.getRecursiveValue(c,a)}else if(/^[\+\/\-\*]$/.test(f))null!==this.compare?this.rightValue[this.rightValue.length]=f:this.leftValue[this.leftValue.length]=f;else if("&&"===f){if(this._compare()===!1)return!1;this.leftValue=[],this.rightValue=[],this.compare=""}else if("||"===f){if(this._compare()===!0)return!0;this.leftValue=[],this.rightValue=[],this.compare=""}else d=this.parsePrimitiveValue(f),""!==this.compare?this.rightValue[this.rightValue.length]=null!==d?d:this.getRecursiveValue(f,a):this.leftValue[this.leftValue.length]=null!==d?d:this.getRecursiveValue(f,a);return this.acceptance(a,e)},c.prototype.parsePrimitiveValue=function(a){var b;return null!==(b=/^['"](.+?)['"]$/.exec(a))?b[1]:null!==(b=/^([0-9\.]+)$/.exec(a))?-1!==b[1].indexOf(".")?parseFloat(b[1]):parseInt(b[1],10):null},c.prototype._compare=function(){var a=b.make(this.leftValue).calculate(),c=b.make(this.rightValue).calculate();switch(this.compare){case">":return a>c;case"<":return c>a;case">=":return a>=c;case"<=":return c>=a;case"==":return a==c;case"===":return a===c;case"!=":return a!=c;case"!==":return a!==c;default:return!!a}},d.make=function(a,b){return new d(a,b)},d.prototype.analyze=function(a){var b,c,d=[],e=0,f=/\{\{else(?:\s?if\s?)?([\s\S]+?)?\}\}/;if(!f.test(a))return d.push({condition:this.condition,context:a}),d;if(b=a.split(f),d.push({condition:this.condition,context:b.shift().replace(/^\n/,"")}),c=b.length,c%2>0)throw new Error("Syntax Error: If condition id invalid.");for(;c>e;e+=2)d.push({condition:b[e],context:b[e+1].replace(/\n$/,"")});return d},d.prototype.exec=function(a){for(var b,d,e=this.contexts.length,f=0,g="";e>f;++f){if(b=this.contexts[f],void 0===b.condition){g=b.context;break}if(d=new c(b.condition),d.acceptance(a)===!0){g=b.context;break}}return g},e.make=function(a){return new e(a)},e.STATUS_NORMAL=0,e.STATUS_IF=1,e.STATUS_LOOP=16,e.STATUS_PARSING=17,e.prototype.escapeMap={"<":"&lt;",">":"&gt:",'"':"&quot;","'":"&apos;"},e.prototype._escape=function(a){if(null===a||void 0===a)return"";var b=this.escapeMap,c=function(a){return b[a]};return a.toString().replace(/([<>"'])/g,c)},e.prototype.reset=function(){this.idx=0,this.mode=e.STATUS_NORMAL,this.processTree=[],this.parsed=[],this.line=1,this.nestLevel=0},e.prototype.parse=function(a){var b,c,d,f="",g=new RegExp("^"+this.leftDelimiter+"([/])?(.+?)"+this.rightDelimiter+"$"),h="";for(this.reset(),this.param=a||{};this.idx<this.size;)if(d=this.tpl[this.idx],""!==d&&void 0!==d){if(d+this.tpl[this.idx+1]===this.leftDelimiter)this.mode=e.STATUS_PARSING,f=this.leftDelimiter,this.idx++;else if(d+this.tpl[this.idx+1]===this.rightDelimiter){if(this.mode==e.STATUS_NORMAL)throw new Error("Unexpexted right delimiter chars: "+this.rightDelimiter+" at line "+this.line);f+=this.rightDelimiter,c=g.exec(f),c[1]?(b=this.closeProcess(c[2],h),this.nestLevel<1?(""!==b&&(this.parsed[this.parsed.length]=b),h=""):h+=f):(b=this.openProcess(c[2]),this.nestLevel<2?b===!1?h+=f:""!==b&&(this.parsed[this.parsed.length]=b):h+=f),f="",this.idx++}else this.mode===e.STATUS_PARSING?f+=d:this.mode===e.STATUS_IF||this.mode===e.STATUS_LOOP?h+=d:this.parsed[this.parsed.length]=d;"\n"===d&&++this.line,++this.idx}else this.idx++;return this.parsed.join("").replace(/^[\n\s]+|[\n\s]+$/,"")},e.prototype.openProcess=function(a){var b="";return/^if\s/.test(a)?(this.mode=e.STATUS_IF,0===this.nestLevel&&this.processTree.push({mode:this.mode,condition:a.replace(/^if\s(.+?)$/,"$1")}),this.nestLevel++):/^else/.test(a)?(b=!1,this.mode=e.STATUS_IF):/^loop/.test(a)?(0===this.nestLevel&&(this.mode=e.STATUS_LOOP,this.processTree.push({mode:this.mode,condition:a.replace(/^loop\s(.+?)$/,"$1")})),this.nestLevel++):0===this.nestLevel?(b=this.getRecursiveValue(a,this.param),b=this._escape(b),this.mode=e.STATUS_NORMAL):b=!1,b},e.prototype.closeProcess=function(a,b){var c,f,g,h,i,j=[],k="",l=0;switch(this.nestLevel--,this.mode=e.STATUS_NORMAL,a){case"if":0===this.nestLevel?(c=this.processTree.pop(),f=new d(c.condition,b),k=f.exec(this.param),k=e.make(k).parse(this.param)):k=b;break;case"loop":if(0===this.nestLevel){for(c=this.processTree.pop(),g=this.getRecursiveValue(c.condition,this.param)||[],h=g.length;h>l;++l)i="[object Object]"===Object.prototype.toString.call(g[l])?g[l]:{"@data":g[l]},i["@parent"]=this.param,j[j.length]=e.make(b).parse(i).replace(/^[\n\s]+|[\n\s]+$/,"");k=j.join("")}else k=b}return k},e.prototype.getRecursiveValue=function(a,b){var c,d=a.indexOf(".");return-1===d?a in b?b[a]:null:(c=a.slice(0,d),c in b&&"object"==typeof b[c]?this.getRecursiveValue(a.slice(++d),b[c]):null)},a.Retriever=e}(this);