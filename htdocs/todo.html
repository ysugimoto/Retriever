<!doctype html><html><head>

<meta charset="UTF-8">
<title>DataBind test</title>
<link rel="stylesheet" type="text/css" href="style.css">
<script src="retriever.js"></script>

</head>

<body>
<div id="todoapp">
    <header>
        <h1>Todos by Retriever.js</h1>
        <input id="new-todo" type="text" placeholder="What need to be done?" data-bind-name="inputTitle" data-bind-event="keyenter" data-bind-handler="entered">
    </header>

    <section id="main" style="display:block">
        <div data-bind-name="todos" data-bind-show="this.todos.length > 0">
            <input id="toggle-all" type="checkbox" data-bind-name="checkAll" data-bind-event="change" />
            <label for="toggle-all">Mark all as complete</label>
            <ul id="todo-list" data-bind-name="todos" data-bind-each>
                <li data-bind-name="oncheck" data-bind-event="dblclick" data-bind-attr="data-done" data-bind-handler="toggleEditMode">
                    <div class="view">
                        <input class="toggle" type="checkbox" data-bind-name="checked" data-bind-prop="checked" />
                        <label data-bind-name="text">{{text}}</label>
                        <a class="destroy"></a>
                    </div>
                    <input class="edit" type="text" data-bind-name="text" data-bind-name="keyenter" data-bind-handler="toggleEditModeInput">
                </li>
            </ul>
        </div>
    </section>

    <footer style="display:block">
        <div data-bind-name="todos" data-bind-show="this.todos.length > 0">
            <div class="todo-count"><b data-bind-name="todoCount"></b> items left</div>
            <a id="clear-completed" data-bind-name="clear" data-bind-event="click">
                Clear <span data-bind-name="countDone"></span>
            </a>
            <br style="clear:both" />
        </div>
    </footer>
</div>

<script>
    var ViewModel = DataBind.Model.extend('ViewModel', function() {
        this.inputTitle = DataBind.observe('');
        this.entered = function(view) {
            this.todos.push(new TodoModel(view.getValue()));
            this.inputTitle.set('');
        };

        this.todos = DataBind.observe([]);
        this.checkAll = function(view) {
            var chk = view.node.checked;

            this.todos.forEach(function(obj) {
                obj.checked.set(chk);
            });
        };
        this.todoCount = DataBind.observe(function() {
            var cnt = 0;
            this.todos.forEach(function(obj) {
                if ( obj.checked.get() === false ) {
                    cnt++;
                }
            });

            return cnt;
        });
        this.countDone = DataBind.observe(function() {
            var str = '';
            var cnt = this.countDoneTodos();

            str += cnt + ' completed item';
            if ( cnt > 1 ) {
                str += 's';
            }
            return str;

        });
        this.countDoneTodos = function() {
            var cnt = 0;
            this.todos.forEach(function(obj) {
                if ( obj.checked.get() === true ) {
                    cnt++;
                }
            });

            return cnt;
        };
        this.clear = function() {
            this.todos.filter(function(todo) {
                return todo.checked.get() === false;
            });
            document.getElementById('toggle-all').checked = false;
        };
    });
    
var TodoModel = DataBind.Model.extend('TodoModel', function(name) {
    this.checked = DataBind.observe(false);
    this.text    = DataBind.observe(name);
    this.toggleEditMode = function(view, evt) {
        var node = view.node;

        if ( ! node.classList.contains('editing') ) {
            node.classList.add('editing');
        } else {
            node.classList.remove('editing');
        }
    };
    this.toggleEditModeInput = function(view, evt) {
        this.text.set(view.getValue());
        view.node.parentNode.classList.toggle('editing');
    };
    this.oncheck = DataBind.observe(function() {
        var attr = '';

        if ( this.checked.get() === true ) {
            //this.checked.set(true);
            attr = 'done';
        }
        ViewModel.todoCount.call();
        return attr;
        
    });
    this.countDoneText = DataBind.observe(function(value, evt) {
        var cnt = ViewModel.countDoneTodos();
        var link = document.getElementById('clear-completed');

        if ( cnt > 0 ) {
            link.removeAttribute('data-bind-show');
        } else {
            link.setAttribute('data-bind-show', 1);
        }
        ViewModel.countDone.call();
        //ViewModel.countDone.update();
    });
});

    var ViewModel = new ViewModel();

    ViewModel.subscribe();




</script>
</body>
</html>
